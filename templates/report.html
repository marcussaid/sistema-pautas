{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-2 py-4 bg-gray-50 dark:bg-gray-900 min-h-screen transition-all duration-200">
    <div class="mb-8 flex flex-col sm:flex-row justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-4 sm:mb-0 transition-colors duration-200">Relatório de Demandas</h1>
        <div class="flex items-center space-x-2">
            <a href="{{ url_for('form') }}" class="bg-teal-500 dark:bg-teal-600 hover:bg-teal-600 dark:hover:bg-teal-500 text-white font-bold py-2 px-4 rounded transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                <i class="fas fa-plus mr-2"></i>Nova Demanda
            </a>
            {% if current_user.is_superuser %}
            <a href="{{ url_for('import_csv') }}" class="bg-green-600 dark:bg-green-700 hover:bg-green-700 dark:hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                <i class="fas fa-file-import mr-2"></i>Importar
            </a>
            {% endif %}
            <a href="/export_csv" id="exportButton" class="bg-green-600 dark:bg-green-700 hover:bg-green-700 dark:hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                <i class="fas fa-file-export mr-2"></i>Exportar
            </a>
        </div>
    </div>

    <!-- Removido o dashboard de estatísticas -->

    <!-- Removido o gráfico de status -->
    <!-- Removido o item "Demandas Recentes" -->

    <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md transition-all duration-200">
        <div class="flex items-center mb-4">
            <div class="relative flex-grow">
                <input type="text" id="searchInput" placeholder="Buscar demandas..." 
                       class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 transition-all duration-200">
                <div class="absolute left-3 top-2.5">
                    <i class="fas fa-search text-gray-400 dark:text-gray-500"></i>
                </div>
            </div>
            <div class="ml-4">
                <select id="statusFilter" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 transition-all duration-200">
                    <option value="">Todos os status</option>
                    {% for status in status_list %}
                        <option value="{{ status }}">{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <!-- Pesquisa Avançada Integrada -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-2">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-lg font-semibold text-gray-900 dark:text-white transition-colors duration-200">Pesquisa Avançada</h2>
                <button id="toggleSearch" class="text-teal-600 dark:text-teal-400 hover:text-teal-800 dark:hover:text-teal-200 transition-colors duration-200">
                    <i class="fas fa-chevron-down" id="searchIcon"></i>
                </button>
            </div>
            
            <div id="searchContainer" class="hidden">
                <form id="advancedSearchForm" class="mt-3">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="termo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200">Termo de Pesquisa</label>
                            <input type="text" id="termoAvancado" name="termo" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors duration-200"
                                placeholder="Pesquisar por demanda, assunto, local...">
                        </div>
                        <div>
                            <label for="statusAvancado" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200">Status</label>
                            <select id="statusAvancado" name="status" 
                                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors duration-200">
                                <option value="">Todos</option>
                                {% for status in status_list %}
                                <option value="{{ status }}">{{ status }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label for="data_inicio" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200">Data Início</label>
                            <input type="date" id="data_inicio" name="data_inicio" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors duration-200">
                        </div>
                        <div>
                            <label for="data_fim" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 transition-colors duration-200">Data Fim</label>
                            <input type="date" id="data_fim" name="data_fim" 
                                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition-colors duration-200">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="button" id="limparFiltros" class="bg-gray-500 dark:bg-gray-600 hover:bg-gray-600 dark:hover:bg-gray-500 text-white font-bold py-2 px-4 rounded mr-2 transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                            <i class="fas fa-eraser mr-2"></i>Limpar
                        </button>
                        <button type="button" id="aplicarFiltrosAvancados" 
                                class="bg-teal-500 dark:bg-teal-600 hover:bg-teal-600 dark:hover:bg-teal-500 text-white font-bold py-2 px-4 rounded transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98]">
                            <i class="fas fa-search mr-2"></i>Pesquisar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% if registros %}
        <div class="relative overflow-x-auto bg-white dark:bg-gray-800 rounded-lg shadow-md transition-all duration-200">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700">
                <div class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">
                    <span id="registrosCounter">Mostrando {{ registros|length }} registro(s)</span>
                </div>
                <div class="flex space-x-2">
                    <button id="toggleColumns" class="text-gray-700 dark:text-gray-300 hover:text-teal-600 dark:hover:text-teal-400 focus:outline-none transition-colors duration-200">
                        <i class="fas fa-columns mr-1"></i>Colunas
                    </button>
<!-- Removendo botões de redimensionar -->
<!--
<button id="increaseHeight" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none transition-colors duration-200">
    <i class="fas fa-expand-arrows-alt mr-1"></i>+
</button>
<button id="decreaseHeight" class="text-gray-700 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400 focus:outline-none transition-colors duration-200">
    <i class="fas fa-compress-arrows-alt mr-1"></i>-
</button>
-->
                    <select id="sortSelect" class="text-sm border border-gray-300 dark:border-gray-600 rounded px-2 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-teal-500 dark:focus:ring-teal-400 transition-all duration-200">
                        <option value="data-desc">Data (mais recente)</option>
                        <option value="data-asc">Data (mais antiga)</option>
                        <option value="demanda-asc">Demanda (A-Z)</option>
                        <option value="demanda-desc">Demanda (Z-A)</option>
                        <option value="direcionamentos-asc">Direcionamentos (A-Z)</option>
                        <option value="direcionamentos-desc">Direcionamentos (Z-A)</option>
                        <option value="status-asc">Status (A-Z)</option>
                    </select>
                </div>
            </div>
            <div class="overflow-x-auto" style="max-height: 70vh;">
                <table class="w-full table-auto">
                    <thead class="bg-gray-100 dark:bg-gray-700 transition-colors duration-200 sticky top-0">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200 column-data w-24">Data</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200 column-demanda w-48">Demanda</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200 column-assunto w-48">Assunto</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200 column-local w-32">Local</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200 column-direcionamentos w-60">Direcionamentos</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200 column-status w-32">Status</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200 column-acoes w-20">Ações</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700 transition-colors duration-200" id="tableBody">
                        {% for registro in registros %}
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200" data-demanda-row
                            data-demanda="{{ registro['demanda'] }}"
                            data-assunto="{{ registro['assunto'] }}"
                            data-status="{{ registro['status'] }}"
                            data-data="{{ registro['data'] }}"
                            data-local="{{ registro['local'] }}"
                            data-direcionamentos="{{ registro['direcionamentos'] }}"
                            data-registro-id="{{ registro['id'] }}">
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white transition-colors duration-200 column-data">
                                {{ registro['data'] }}
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-900 dark:text-white transition-colors duration-200 column-demanda">
                                <div class="break-words whitespace-normal" title="{{ registro['demanda'] }}">{{ registro['demanda'] }}</div>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-900 dark:text-white transition-colors duration-200 column-assunto">
                                <div class="break-words whitespace-normal" title="{{ registro['assunto'] }}">{{ registro['assunto'] }}</div>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-900 dark:text-white transition-colors duration-200 column-local">
                                <div class="break-words whitespace-normal" title="{{ registro['local'] }}">{{ registro['local'] }}</div>
                            </td>
                            <td class="px-4 py-4 text-sm text-gray-900 dark:text-white transition-colors duration-200 column-direcionamentos">
                                <div class="break-words whitespace-normal" title="{{ registro['direcionamentos'] }}">{{ registro['direcionamentos'] }}</div>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm transition-colors duration-200 column-status">
                                <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                                    {% if registro['status'] == 'Em andamento' %}
                                        bg-teal-100 dark:bg-teal-900/50 text-teal-800 dark:text-teal-300 border border-teal-200 dark:border-teal-800
                                    {% elif registro['status'] == 'Concluído' %}
                                        bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300 border border-green-200 dark:border-green-800
                                    {% elif registro['status'] == 'Pendente' %}
                                        bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300 border border-yellow-200 dark:border-yellow-800
                                    {% elif registro['status'] == 'Cancelado' %}
                                        bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300 border border-red-200 dark:border-red-800
                                    {% endif %}
                                ">
                                    {{ registro['status'] }}
                                </span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white transition-colors duration-200 column-acoes">
                                <div class="flex items-center justify-center space-x-2">
                                    <button class="text-teal-600 dark:text-teal-400 hover:text-teal-800 dark:hover:text-teal-300 focus:outline-none transition-colors duration-200" 
                                            data-id="{{ registro.id }}"
                                            data-demanda="{{ registro.demanda }}"
                                            data-data="{{ registro.data }}"
                                            data-assunto="{{ registro.assunto }}"
                                            data-local="{{ registro.local }}"
                                            data-direcionamentos="{{ registro.direcionamentos }}"
                                            data-status="{{ registro.status }}"
                                            data-ultimo-editor="{{ registro.ultimo_editor }}"
                                            data-data-ultima-edicao="{{ registro.data_ultima_edicao }}"
                                            onclick="showDetailsFromButton(this)">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="{{ url_for('edit_registro', registro_id=registro.id) }}" class="text-yellow-600 dark:text-yellow-400 hover:text-yellow-800 dark:hover:text-yellow-300 focus:outline-none transition-colors duration-200">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    {% if current_user.is_superuser %}
                                    <button class="text-red-600 dark:text-red-400 hover:text-red-800 dark:hover:text-red-300 focus:outline-none transition-colors duration-200" 
                                            onclick="confirmDelete('{{ registro.id }}', '{{ registro.demanda }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="px-4 py-3 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-800 transition-colors duration-200">
                <nav class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 transition-colors duration-200">
                            Exibindo <span class="font-medium" id="registrosCounterFooter">{{ registros|length }}</span> registros
                        </p>
                    </div>
                    <!-- Aqui pode ser adicionada paginação futuramente -->
                </nav>
            </div>
        </div>
    {% else %}
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 text-center transition-all duration-200">
        <p class="text-gray-600 dark:text-gray-400 text-lg transition-colors duration-200">Nenhum registro encontrado.</p>
        <p class="mt-2 text-gray-600 dark:text-gray-400 transition-colors duration-200">
            Clique em <span class="font-bold">Nova Demanda</span> para adicionar um registro.
        </p>
    </div>
    {% endif %}
</div>

<!-- Modal de Detalhes -->
<div id="detailsModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden transition-opacity duration-200">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 transition-all duration-200 transform scale-95 opacity-0" id="modalContent">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white transition-colors duration-200" id="modalTitle"></h2>
                <div class="flex items-center space-x-2">
                    <button onclick="printModalDetails()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200" title="Imprimir detalhes">
                        <i class="fas fa-print text-xl"></i>
                    </button>
                    <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Data</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalData"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Assunto</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalAssunto"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Local</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalLocal"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Direcionamentos</p>
                    <p class="text-lg text-gray-900 dark:text-white whitespace-pre-line transition-colors duration-200" id="modalDirecionamentos"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Status</p>
                    <p class="inline-block px-2 py-1 text-sm rounded-full mt-1 transition-colors duration-200" id="modalStatus"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Última Edição</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalUltimaEdicao"></p>
                </div>
                <!-- Nova seção para anexos -->
                <div id="modalAnexosContainer" class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200 mb-2">Anexos</p>
                    <div id="modalAnexos" class="flex flex-wrap gap-2">
                        <p id="modalAnexosCarregando" class="text-sm text-gray-500 italic">Carregando anexos...</p>
                        <p id="modalSemAnexos" class="text-sm text-gray-500 italic hidden">Nenhum anexo disponível</p>
                    </div>
                    <!-- Contêiner para visualização expandida de imagens -->
                    <div id="imageViewerContainer" class="hidden mt-4">
                        <div class="relative">
                            <img id="expandedImage" class="w-full rounded-lg border border-gray-300 dark:border-gray-600 shadow-md" src="" alt="Anexo">
                            <button onclick="closeImageViewer()" class="absolute top-2 right-2 bg-white dark:bg-gray-800 rounded-full p-1 shadow-md text-gray-700 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Conteúdo para impressão (invisível na página) -->
<div id="printContent" style="display: none;"></div>

<!-- Modal de Colunas -->
<div id="columnsModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden transition-opacity duration-200">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transition-all duration-200 transform scale-95 opacity-0" id="columnsModalContent">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white transition-colors duration-200">Configurar Colunas</h2>
                <button onclick="closeColumnsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-3">
                <div class="flex items-center">
                    <input type="checkbox" id="toggle-data" class="h-4 w-4 text-teal-500 focus:ring-teal-400 border-gray-300 rounded" checked>
                    <label for="toggle-data" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Data</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggle-demanda" class="h-4 w-4 text-teal-500 focus:ring-teal-400 border-gray-300 rounded" checked>
                    <label for="toggle-demanda" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Demanda</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggle-assunto" class="h-4 w-4 text-teal-500 focus:ring-teal-400 border-gray-300 rounded" checked>
                    <label for="toggle-assunto" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Assunto</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggle-local" class="h-4 w-4 text-teal-500 focus:ring-teal-400 border-gray-300 rounded" checked>
                    <label for="toggle-local" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Local</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggle-direcionamentos" class="h-4 w-4 text-teal-500 focus:ring-teal-400 border-gray-300 rounded" checked>
                    <label for="toggle-direcionamentos" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Direcionamentos</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="toggle-status" class="h-4 w-4 text-teal-500 focus:ring-teal-400 border-gray-300 rounded" checked>
                    <label for="toggle-status" class="ml-2 block text-sm text-gray-900 dark:text-gray-200">Status</label>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeColumnsModal()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded">
                    Aplicar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="deleteModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden transition-opacity duration-200">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-md w-full mx-4 transition-all duration-200 transform scale-95 opacity-0" id="deleteModalContent">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white transition-colors duration-200">Confirmar Exclusão</h2>
                <button onclick="closeDeleteModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-6">
                <p class="text-gray-700 dark:text-gray-300">Tem certeza que deseja excluir o registro:</p>
                <p class="text-gray-900 dark:text-white font-bold mt-2" id="deleteItemName"></p>
                <p class="text-red-600 mt-4 text-sm">Esta ação não pode ser desfeita!</p>
            </div>
            <div class="flex justify-end space-x-3">
                <button onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors duration-200">
                    Cancelar
                </button>
                <button id="confirmDeleteButton" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors duration-200">
                    Excluir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Nova função para obter os dados do botão e passá-los para a função showDetails de forma segura
function showDetailsFromButton(button) {
    // Obter os dados diretamente do botão usando dataset
    const demanda = button.dataset.demanda || '';
    const data = button.dataset.data || '';
    const assunto = button.dataset.assunto || '';
    const local = button.dataset.local || '';
    const direcionamentos = button.dataset.direcionamentos || '';
    const status = button.dataset.status || '';
    const ultimoEditor = button.dataset.ultimoEditor || '';
    const dataUltimaEdicao = button.dataset.dataUltimaEdicao || '';
    const registroId = button.dataset.id || '';
    
    // Chamar a função original com os dados seguros
    showDetails(demanda, data, assunto, local, direcionamentos, status, ultimoEditor, dataUltimaEdicao);
    
    // Carrega anexos para este registro
    if (registroId) {
        loadAnexos(registroId);
    }
}

// Função para carregar anexos do registro
function loadAnexos(registroId) {
    // Resetar o contêiner de anexos
    const anexosContainer = document.getElementById('modalAnexos');
    const carregandoElement = document.getElementById('modalAnexosCarregando');
    const semAnexosElement = document.getElementById('modalSemAnexos');
    
    // Limpar imagens anteriores e mostrar carregando
    Array.from(anexosContainer.querySelectorAll(':not(#modalAnexosCarregando):not(#modalSemAnexos)')).forEach(el => el.remove());
    carregandoElement.classList.remove('hidden');
    semAnexosElement.classList.add('hidden');
    
    // Ocultar o visualizador de imagem expandida
    document.getElementById('imageViewerContainer').classList.add('hidden');
    
    // Buscar anexos via API
    fetch(`/edit/${registroId}`)
        .then(response => response.text())
        .then(html => {
            // Criar um DOM temporário para analisar o HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            
            // Extrair os anexos do HTML
            const anexosElements = doc.querySelectorAll('#anexosList > div');
            carregandoElement.classList.add('hidden');
            
            if (anexosElements.length === 0) {
                semAnexosElement.classList.remove('hidden');
                return;
            }
            
            // Processar cada anexo
            anexosElements.forEach(anexoEl => {
                const anexoId = anexoEl.id.replace('anexo-', '');
                const nomeAnexo = anexoEl.querySelector('span').textContent;
                
                // Verificar se é uma imagem pelo nome do arquivo
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(nomeAnexo);
                
                // Criar elemento para o anexo
                const anexoItem = document.createElement('div');
                anexoItem.className = 'rounded-lg border border-gray-200 dark:border-gray-700 p-2 flex flex-col items-center bg-white dark:bg-gray-700';
                
                if (isImage) {
                    // Criar visualização em miniatura para imagens
                    const imgElement = document.createElement('img');
                    imgElement.src = `/view_image/${registroId}/${anexoId}`;
                    imgElement.alt = nomeAnexo;
                    imgElement.className = 'w-24 h-24 object-cover rounded cursor-pointer mb-1';
                    imgElement.onclick = () => showExpandedImage(`/view_image/${registroId}/${anexoId}`, nomeAnexo);
                    anexoItem.appendChild(imgElement);
                } else {
                    // Ícone para arquivos não-imagem
                    const iconElement = document.createElement('div');
                    iconElement.className = 'w-24 h-24 flex items-center justify-center text-gray-500 dark:text-gray-400';
                    iconElement.innerHTML = '<i class="fas fa-file fa-2x"></i>';
                    anexoItem.appendChild(iconElement);
                }
                
                // Nome do arquivo
                const nameElement = document.createElement('div');
                nameElement.className = 'text-xs text-center text-gray-700 dark:text-gray-300 mt-1 max-w-24 overflow-hidden text-ellipsis';
                nameElement.textContent = nomeAnexo.length > 15 ? nomeAnexo.substring(0, 15) + '...' : nomeAnexo;
                nameElement.title = nomeAnexo;
                anexoItem.appendChild(nameElement);
                
                // Botão para download
                const downloadButton = document.createElement('a');
                downloadButton.href = `/download_anexo/${registroId}/${anexoId}`;
                downloadButton.className = 'text-blue-600 dark:text-blue-400 hover:text-blue-800 mt-1';
                downloadButton.title = 'Download';
                downloadButton.innerHTML = '<i class="fas fa-download"></i>';
                downloadButton.target = '_blank';
                anexoItem.appendChild(downloadButton);
                
                anexosContainer.appendChild(anexoItem);
            });
        })
        .catch(err => {
            console.error('Erro ao carregar anexos:', err);
            carregandoElement.classList.add('hidden');
            semAnexosElement.classList.remove('hidden');
            semAnexosElement.textContent = 'Erro ao carregar anexos';
        });
}

// Função para exibir imagem expandida
function showExpandedImage(src, alt) {
    const expandedImage = document.getElementById('expandedImage');
    expandedImage.src = src;
    expandedImage.alt = alt || 'Imagem anexada';
    
    document.getElementById('imageViewerContainer').classList.remove('hidden');
}

// Função para fechar o visualizador de imagem
function closeImageViewer() {
    document.getElementById('imageViewerContainer').classList.add('hidden');
}

// Função para mostrar detalhes do registro
function showDetails(demanda, data, assunto, local, direcionamentos, status, ultimoEditor, dataUltimaEdicao) {
    document.getElementById('modalTitle').textContent = demanda;
    document.getElementById('modalData').textContent = data;
    document.getElementById('modalAssunto').textContent = assunto;
    document.getElementById('modalLocal').textContent = local || 'N/A';
    document.getElementById('modalDirecionamentos').textContent = direcionamentos || 'N/A';
    
    const statusEl = document.getElementById('modalStatus');
    statusEl.textContent = status;
    
    // Estilos para o status
    statusEl.className = 'inline-block px-2 py-1 text-sm rounded-full mt-1 transition-colors duration-200';
    
    if (status === 'Em andamento') {
        statusEl.classList.add('bg-teal-100', 'dark:bg-teal-900/50', 'text-teal-800', 'dark:text-teal-300', 'border', 'border-teal-200', 'dark:border-teal-800');
    } else if (status === 'Concluído') {
        statusEl.classList.add('bg-green-100', 'dark:bg-green-900/50', 'text-green-800', 'dark:text-green-300', 'border', 'border-green-200', 'dark:border-green-800');
    } else if (status === 'Pendente') {
        statusEl.classList.add('bg-yellow-100', 'dark:bg-yellow-900/50', 'text-yellow-800', 'dark:text-yellow-300', 'border', 'border-yellow-200', 'dark:border-yellow-800');
    } else if (status === 'Cancelado') {
        statusEl.classList.add('bg-red-100', 'dark:bg-red-900/50', 'text-red-800', 'dark:text-red-300', 'border', 'border-red-200', 'dark:border-red-800');
    }
    
    // Formatar a data de última edição
    const ultimaEdicao = ultimoEditor ? 
        `Por ${ultimoEditor} em ${dataUltimaEdicao ? new Date(dataUltimaEdicao).toLocaleString() : 'Não disponível'}` : 
        'Não disponível';
    document.getElementById('modalUltimaEdicao').textContent = ultimaEdicao;
    
    // Mostrar o modal com animação
    const modal = document.getElementById('detailsModal');
    const modalContent = document.getElementById('modalContent');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

// Função para fechar o modal
function closeModal() {
    const modal = document.getElementById('detailsModal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 200);
}

// Funções para o modal de colunas
function showColumnsModal() {
    const modal = document.getElementById('columnsModal');
    const modalContent = document.getElementById('columnsModalContent');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeColumnsModal() {
    const modal = document.getElementById('columnsModal');
    const modalContent = document.getElementById('columnsModalContent');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 200);
}

// Toggle formulário de pesquisa avançada
document.getElementById('toggleSearch').addEventListener('click', function() {
    const container = document.getElementById('searchContainer');
    const icon = document.getElementById('searchIcon');
    
    if (container.classList.contains('hidden')) {
        container.classList.remove('hidden');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    } else {
        container.classList.add('hidden');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    }
});

// Adiciona suporte à tecla Enter no formulário de pesquisa avançada
document.getElementById('advancedSearchForm').addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Evita o envio padrão do formulário
        aplicarFiltrosAvancados();
    }
});

// Integra a pesquisa simples com a avançada para que o valor seja compartilhado
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchValue = e.target.value;
    const searchValueNormalizado = normalizarTexto(searchValue);
    
    // Se o campo de pesquisa avançada estiver visível, atualize-o também
    if (!document.getElementById('searchContainer').classList.contains('hidden')) {
        document.getElementById('termoAvancado').value = searchValue;
    }
    
    // Continua com a lógica existente de filtragem em tempo real
    const rows = document.querySelectorAll('[data-demanda-row]');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const demanda = normalizarTexto(row.getAttribute('data-demanda'));
        const assunto = normalizarTexto(row.getAttribute('data-assunto'));
        const status = normalizarTexto(row.getAttribute('data-status'));
        const direcionamentos = normalizarTexto(row.getAttribute('data-direcionamentos'));
        const local = normalizarTexto(row.dataset.local || '');
        
        // Lógica de busca mais robusta
        const match = searchValueNormalizado === '' || 
                      demanda.includes(searchValueNormalizado) || 
                      assunto.includes(searchValueNormalizado) || 
                      status.includes(searchValueNormalizado) ||
                      direcionamentos.includes(searchValueNormalizado) ||
                      local.includes(searchValueNormalizado) ||
                      // Também busca palavras individuais
                      (searchValueNormalizado.length > 2 && searchValueNormalizado.split(' ').some(palavra => 
                          palavra.length > 2 && (
                              demanda.includes(palavra) ||
                              assunto.includes(palavra) ||
                              local.includes(palavra) ||
                              direcionamentos.includes(palavra)
                          )
                      ));
        
        if (match) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Atualiza o contador
    document.getElementById('registrosCounter').textContent = `Mostrando ${visibleCount} registro(s)`;
    document.getElementById('registrosCounterFooter').textContent = visibleCount;
    
    // Exibe mensagem se nenhum resultado for encontrado
    if (visibleCount === 0 && searchValue.trim() !== '') {
        document.getElementById('registrosCounter').textContent = `Nenhum registro encontrado para "${searchValue}"`;
        document.getElementById('registrosCounterFooter').textContent = '0';
    }
});

// Filtrar por status
document.getElementById('statusFilter').addEventListener('change', function(e) {
    const statusValue = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('[data-demanda-row]');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status').toLowerCase();
        
        if (statusValue === '' || status === statusValue) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Atualiza o contador
    document.getElementById('registrosCounter').textContent = `Mostrando ${visibleCount} registro(s)`;
    document.getElementById('registrosCounterFooter').textContent = visibleCount;
});

// Ordenação da tabela
document.getElementById('sortSelect').addEventListener('change', function(e) {
    const sortValue = e.target.value;
    const [field, direction] = sortValue.split('-');
    const tbody = document.getElementById('tableBody');
    
    // Obter todas as linhas e converter para array
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Ordenar as linhas
    rows.sort((a, b) => {
        let aValue = a.getAttribute(`data-${field}`);
        let bValue = b.getAttribute(`data-${field}`);
        
        // Para datas, converter para objetos Date
        if (field === 'data') {
            aValue = new Date(aValue);
            bValue = new Date(bValue);
        } else {
            aValue = aValue.toLowerCase();
            bValue = bValue.toLowerCase();
        }
        
        // Aplicar a direção da ordenação
        if (direction === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });
    
    // Remover as linhas existentes
    rows.forEach(row => row.remove());
    
    // Adicionar as linhas ordenadas
    rows.forEach(row => tbody.appendChild(row));
});

// Toggle de colunas
document.getElementById('toggleColumns').addEventListener('click', function() {
    showColumnsModal();
});

// Configurar eventos para checkboxes de colunas
const columnToggles = ['data', 'demanda', 'assunto', 'local', 'direcionamentos', 'status'];
columnToggles.forEach(column => {
    const checkbox = document.getElementById(`toggle-${column}`);
    checkbox.addEventListener('change', function() {
        const elements = document.querySelectorAll(`.column-${column}`);
        elements.forEach(el => {
            el.style.display = this.checked ? '' : 'none';
        });
    });
});


// Atualiza o link de exportação com os filtros aplicados
function updateExportLink() {
    const exportButton = document.getElementById('exportButton');
    let exportUrl = '/export_csv';
    
    // Adiciona parâmetros de filtro atual
    const params = new URLSearchParams();
    
    // Adiciona o filtro de status se estiver ativo
    const statusFilter = document.getElementById('statusFilter').value;
    if (statusFilter) {
        params.append('status', statusFilter);
    }
    
    // Adiciona o termo de pesquisa se estiver ativo
    const searchInput = document.getElementById('searchInput').value;
    if (searchInput) {
        params.append('termo', searchInput);
    }
    
    // Adiciona os parâmetros à URL se houver algum
    if (params.toString()) {
        exportUrl += '?' + params.toString();
    }
    
    // Atualiza o link do botão de exportação
    exportButton.href = exportUrl;
}

// Chama a função quando os filtros são alterados
document.getElementById('statusFilter').addEventListener('change', updateExportLink);
document.getElementById('searchInput').addEventListener('input', updateExportLink);

// Funções para o modal de exclusão
function confirmDelete(id, nome) {
    document.getElementById('deleteItemName').textContent = nome;
    
    // Configurar o botão de confirmação
    const confirmButton = document.getElementById('confirmDeleteButton');
    confirmButton.onclick = function() {
        // Executar a exclusão
        deleteRegistro(id);
    };
    
    // Mostrar o modal
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    const modalContent = document.getElementById('deleteModalContent');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 200);
}

function deleteRegistro(id) {
    // Criar uma requisição AJAX
    fetch(`/delete_registro/${id}`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Fechar o modal
            closeDeleteModal();
            // Exibir mensagem de sucesso
            showToast('Registro excluído com sucesso!', 'success');
            // Remover a linha da tabela
            const row = document.querySelector(`tr[data-registro-id="${id}"]`);
            if (row) {
                row.remove();
                // Atualizar o contador de registros
                updateRecordCounter();
            } else {
                // Se não encontrar a linha, recarregar a página
                window.location.reload();
            }
        } else {
            // Exibir mensagem de erro
            showToast(data.message || 'Erro ao excluir registro', 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao comunicar com o servidor', 'error');
    });
}

// Função para exibir mensagens toast
function showToast(message, type = 'info') {
    // Criar elemento toast
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 px-4 py-2 rounded shadow-lg z-50 transition-all duration-300 transform translate-y-full opacity-0';
    
    // Definir cores baseadas no tipo
    if (type === 'success') {
        toast.classList.add('bg-green-600', 'text-white');
    } else if (type === 'error') {
        toast.classList.add('bg-red-600', 'text-white');
    } else {
        toast.classList.add('bg-teal-500', 'text-white');
    }
    
    // Adicionar mensagem
    toast.textContent = message;
    
    // Adicionar ao DOM
    document.body.appendChild(toast);
    
    // Animar entrada
    setTimeout(() => {
        toast.classList.remove('translate-y-full', 'opacity-0');
    }, 10);
    
    // Remover após 3 segundos
    setTimeout(() => {
        toast.classList.add('translate-y-full', 'opacity-0');
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Função para atualizar o contador de registros
function updateRecordCounter() {
    const visibleRows = document.querySelectorAll('tr[data-demanda-row]:not([style*="display: none"])');
    const counter = document.getElementById('registrosCounter');
    if (counter) {
        counter.textContent = `Mostrando ${visibleRows.length} registro(s)`;
    }
    const counterFooter = document.getElementById('registrosCounterFooter');
    if (counterFooter) {
        counterFooter.textContent = visibleRows.length;
    }
}

// Função para imprimir os detalhes do modal
function printModalDetails() {
    // Obtém os dados do modal
    const titulo = document.getElementById('modalTitle').textContent;
    const data = document.getElementById('modalData').textContent;
    const assunto = document.getElementById('modalAssunto').textContent;
    const local = document.getElementById('modalLocal').textContent;
    const direcionamentos = document.getElementById('modalDirecionamentos').textContent;
    const status = document.getElementById('modalStatus').textContent;
    const ultimaEdicao = document.getElementById('modalUltimaEdicao').textContent;
    
    // Captura as imagens visíveis no modal
    const anexosDivs = document.querySelectorAll('#modalAnexos > div');
    let anexosHtml = '';
    
    // Verifica se existem anexos
    if (anexosDivs.length > 0 && !document.getElementById('modalSemAnexos').offsetParent && !document.getElementById('modalAnexosCarregando').offsetParent) {
        anexosHtml = `
            <div class="info-section">
                <div class="info-label">Anexos:</div>
                <div class="info-value anexos-container">
        `;
        
        // Processa cada anexo
        anexosDivs.forEach(anexoDiv => {
            const img = anexoDiv.querySelector('img');
            const nome = anexoDiv.querySelector('.text-xs').title;
            
            // Se for uma imagem, adiciona a imagem ao documento
            if (img) {
                anexosHtml += `
                    <div class="anexo-item">
                        <div class="anexo-image">
                            <img src="${img.src}" alt="${nome}" style="max-width: 100%; max-height: 300px; margin-bottom: 10px;">
                        </div>
                        <div class="anexo-nome">${nome}</div>
                    </div>
                `;
            } else {
                // Se não for imagem, apenas mostra o nome
                anexosHtml += `
                    <div class="anexo-item">
                        <div class="anexo-icon">
                            <i class="fa fa-file"></i>
                        </div>
                        <div class="anexo-nome">${nome} (Arquivo não visualizável)</div>
                    </div>
                `;
            }
        });
        
        anexosHtml += `
                </div>
            </div>
        `;
    }
    
    // Cria o conteúdo HTML para impressão
    const printableContent = `
        <html>
        <head>
            <title>Detalhes da Demanda: ${titulo}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }
                h1 {
                    font-size: 24px;
                    border-bottom: 1px solid #ddd;
                    padding-bottom: 10px;
                    margin-bottom: 20px;
                }
                .info-section {
                    margin-bottom: 15px;
                }
                .info-label {
                    font-weight: bold;
                    color: #555;
                    margin-bottom: 5px;
                }
                .info-value {
                    margin-left: 20px;
                }
                .status {
                    display: inline-block;
                    padding: 3px 10px;
                    border-radius: 15px;
                    font-weight: bold;
                }
                .status-pendente {
                    background-color: #FEF3C7;
                    color: #92400E;
                    border: 1px solid #F59E0B;
                }
                .status-concluido {
                    background-color: #D1FAE5;
                    color: #065F46;
                    border: 1px solid #10B981;
                }
                .status-andamento {
                    background-color: #DBEAFE;
                    color: #1E40AF;
                    border: 1px solid #3B82F6;
                }
                .status-cancelado {
                    background-color: #FEE2E2;
                    color: #B91C1C;
                    border: 1px solid #EF4444;
                }
                .footer {
                    margin-top: 30px;
                    text-align: center;
                    font-size: 12px;
                    color: #6B7280;
                    border-top: 1px solid #ddd;
                    padding-top: 10px;
                }
                .anexos-container {
                    display: flex;
                    flex-direction: column;
                    gap: 20px;
                    margin-top: 10px;
                }
                .anexo-item {
                    border: 1px solid #ddd;
                    padding: 10px;
                    border-radius: 5px;
                }
                .anexo-nome {
                    font-size: 12px;
                    text-align: center;
                    margin-top: 5px;
                }
                .anexo-image {
                    text-align: center;
                }
            </style>
        </head>
        <body>
            <h1>Detalhes da Demanda</h1>
            
            <div class="info-section">
                <div class="info-label">Demanda:</div>
                <div class="info-value">${titulo}</div>
            </div>
            
            <div class="info-section">
                <div class="info-label">Data:</div>
                <div class="info-value">${data}</div>
            </div>
            
            <div class="info-section">
                <div class="info-label">Assunto:</div>
                <div class="info-value">${assunto}</div>
            </div>
            
            <div class="info-section">
                <div class="info-label">Local:</div>
                <div class="info-value">${local}</div>
            </div>
            
            <div class="info-section">
                <div class="info-label">Direcionamentos:</div>
                <div class="info-value">${direcionamentos}</div>
            </div>
            
            <div class="info-section">
                <div class="info-label">Status:</div>
                <div class="info-value">
                    <span class="status ${status === 'Pendente' ? 'status-pendente' : 
                                          status === 'Concluído' ? 'status-concluido' : 
                                          status === 'Em andamento' ? 'status-andamento' : 
                                          'status-cancelado'}">${status}</span>
                </div>
            </div>
            
            <div class="info-section">
                <div class="info-label">Última Edição:</div>
                <div class="info-value">${ultimaEdicao}</div>
            </div>
            
            ${anexosHtml}
            
            <div class="footer">
                Impresso em: ${new Date().toLocaleString()}
            </div>
        </body>
        </html>
    `;
    
    // Cria uma nova janela para impressão
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printableContent);
    printWindow.document.close();
    
    // Espera o conteúdo carregar e então imprime
    printWindow.onload = function() {
        // Aguarda as imagens carregarem antes de imprimir
        setTimeout(() => {
            printWindow.print();
        }, 500);
    };
}

// Função para normalizar texto para comparação (remove acentos, espaços extras e converte para minúsculas)
function normalizarTexto(texto) {
    if (!texto) return '';
    
    // Converte para string caso seja outro tipo de dado
    texto = String(texto);
    
    // Remove acentos
    texto = texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    
    // Remove espaços extras e converte para minúsculas
    return texto.toLowerCase().trim().replace(/\s+/g, ' ');
}

// Pesquisa avançada na tabela
document.getElementById('aplicarFiltrosAvancados').addEventListener('click', function() {
    aplicarFiltrosAvancados();
});

document.getElementById('limparFiltros').addEventListener('click', function() {
    // Limpa os campos do formulário
    document.getElementById('termoAvancado').value = '';
    document.getElementById('statusAvancado').value = '';
    document.getElementById('data_inicio').value = '';
    document.getElementById('data_fim').value = '';
    
    // Mostra todas as linhas
    const rows = document.querySelectorAll('[data-demanda-row]');
    let visibleCount = 0;
    
    rows.forEach(row => {
        row.style.display = '';
        visibleCount++;
    });
    
    // Atualiza o contador
    document.getElementById('registrosCounter').textContent = `Mostrando ${visibleCount} registro(s)`;
    document.getElementById('registrosCounterFooter').textContent = visibleCount;
});

function aplicarFiltrosAvancados() {
    // Obtém os valores dos filtros
    const termo = normalizarTexto(document.getElementById('termoAvancado').value);
    const status = document.getElementById('statusAvancado').value.toLowerCase();
    const dataInicio = document.getElementById('data_inicio').value;
    const dataFim = document.getElementById('data_fim').value;
    
    // Registra na console para debug
    console.log('Termo de pesquisa normalizado:', termo);
    console.log('Local sendo buscado:', termo.includes('auditorio'), termo.includes('smec'));
    
    // Obtém todas as linhas da tabela
    const rows = document.querySelectorAll('[data-demanda-row]');
    
    // Log de todos os valores locais
    console.log('--- Valores de local em todas as linhas ---');
    rows.forEach((row, index) => {
        const localRaw = row.dataset.local;
        const localNormalizado = normalizarTexto(localRaw || '');
        console.log(`Linha ${index + 1}:`, {
            localRaw: localRaw,
            localNormalizado: localNormalizado
        });
    });
    console.log('----------------------------------------');
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        // Obtém os dados da linha e normaliza para comparação
        const demanda = normalizarTexto(row.getAttribute('data-demanda'));
        const assunto = normalizarTexto(row.getAttribute('data-assunto'));
        const rowStatus = row.getAttribute('data-status').toLowerCase();
        const rowData = row.getAttribute('data-data');
        const direcionamentos = normalizarTexto(row.getAttribute('data-direcionamentos'));
        const local = normalizarTexto(row.dataset.local || '');
        
        // Debug para o campo Local
        if (local.includes('auditorio') || local.includes('smec')) {
            console.log('Encontrado local com Auditório - SMEC:', local);
        }
        
        // Se o termo contém "auditorio" ou "smec", mostrar detalhes de correspondência
        if (termo.includes('auditorio') || termo.includes('smec')) {
            console.log('Verificando correspondência local:', {
                termo: termo,
                local: local,
                localIncluesTermo: local.includes(termo),
                localIncludesAuditorio: local.includes('auditorio'),
                localIncludesSmec: local.includes('smec'),
                auditorio_smec_juntos: local.includes('auditorio - smec')
            });
        }
        
        // Verifica se a linha atende a todos os critérios de filtro
        let match = true;
        
        // Filtra por termo (demanda, assunto, local ou direcionamentos)
        if (termo) {
            // Tenta busca exata e busca parcial para maior flexibilidade
            match = match && (
                demanda.includes(termo) ||
                assunto.includes(termo) ||
                local.includes(termo) ||
                direcionamentos.includes(termo) ||
                // Também verifica palavras individuais para pesquisas parciais
                termo.split(' ').some(palavra => 
                    palavra.length > 2 && (
                        demanda.includes(palavra) ||
                        assunto.includes(palavra) ||
                        local.includes(palavra) ||
                        direcionamentos.includes(palavra)
                    )
                )
            );
        }
        
        // Filtra por status
        if (status) {
            match = match && (rowStatus === status);
        }
        
        // Filtra por data de início
        if (dataInicio) {
            match = match && (rowData >= dataInicio);
        }
        
        // Filtra por data de fim
        if (dataFim) {
            match = match && (rowData <= dataFim);
        }
        
        // Exibe ou oculta a linha com base no resultado do filtro
        if (match) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // Atualiza o contador
    document.getElementById('registrosCounter').textContent = `Mostrando ${visibleCount} registro(s)`;
    document.getElementById('registrosCounterFooter').textContent = visibleCount;
    
    // Feedback sobre a pesquisa
    if (visibleCount === 0 && termo) {
        // Exibe mensagem de nenhum resultado
        document.getElementById('registrosCounter').textContent = `Nenhum registro encontrado para "${document.getElementById('termoAvancado').value}"`;
        document.getElementById('registrosCounterFooter').textContent = '0';
    } else if (visibleCount > 0) {
        // Adiciona uma mensagem de filtro aplicado
        const statusText = status ? `Status: ${status.charAt(0).toUpperCase() + status.slice(1)}` : '';
        const dataText = (dataInicio || dataFim) ? `Período: ${dataInicio || 'início'} a ${dataFim || 'atual'}` : '';
        const termoText = termo ? `Termo: "${document.getElementById('termoAvancado').value}"` : '';
        
        const filtros = [termoText, statusText, dataText].filter(f => f).join(' | ');
        if (filtros) {
            document.getElementById('registrosCounter').textContent += ` (Filtros: ${filtros})`;
        }
    }
}
</script>
{% endblock %}

