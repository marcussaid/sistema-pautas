{% extends 'base.html' %}
{% block content %}
<div class="container mx-auto px-4 py-8 bg-gray-50 dark:bg-gray-900 min-h-screen transition-all duration-200">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white transition-colors duration-200">Relatório de Demandas</h1>
        <a href="{{ url_for('form') }}" 
           class="bg-blue-600 dark:bg-blue-700 hover:bg-blue-700 dark:hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition-all duration-200 hover:shadow-lg transform hover:scale-[1.02] active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-blue-400">
            <i class="fas fa-plus mr-1"></i>Nova Demanda
        </a>
    </div>

    <div class="mb-6 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-md transition-all duration-200">
        <div class="flex items-center mb-4">
            <div class="relative flex-grow">
                <input type="text" id="searchInput" placeholder="Buscar demandas..." 
                       class="w-full px-4 py-2 pl-10 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 transition-all duration-200">
                <div class="absolute left-3 top-2.5">
                    <i class="fas fa-search text-gray-400 dark:text-gray-500"></i>
                </div>
            </div>
            <div class="ml-4">
                <select id="statusFilter" 
                        class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 dark:focus:ring-blue-400 transition-all duration-200">
                    <option value="">Todos os status</option>
                    {% for status in status_list %}
                        <option value="{{ status }}">{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    {% if registros %}
    <div class="relative overflow-x-auto">
        <table class="w-full bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden transition-all duration-200">
            <thead class="bg-gray-100 dark:bg-gray-700 transition-colors duration-200">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200">Data</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200">Demanda</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200">Assunto</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200">Local</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider transition-colors duration-200">Ações</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 dark:divide-gray-700 transition-colors duration-200">
                {% for registro in registros %}
                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200" data-demanda-row
                    data-demanda="{{ registro['demanda'] }}"
                    data-assunto="{{ registro['assunto'] }}"
                    data-status="{{ registro['status'] }}">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white transition-colors duration-200">
                        {{ registro['data'] }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white transition-colors duration-200">
                        {{ registro['demanda'] }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white transition-colors duration-200">
                        {{ registro['assunto'] }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white transition-colors duration-200">
                        {{ registro['local'] }}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm transition-colors duration-200">
                        <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full 
                            {% if registro['status'] == 'Em andamento' %}
                                bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-300 border border-blue-200 dark:border-blue-800
                            {% elif registro['status'] == 'Concluído' %}
                                bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300 border border-green-200 dark:border-green-800
                            {% elif registro['status'] == 'Pendente' %}
                                bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300 border border-yellow-200 dark:border-yellow-800
                            {% elif registro['status'] == 'Cancelado' %}
                                bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300 border border-red-200 dark:border-red-800
                            {% endif %}
                        ">
                            {{ registro['status'] }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white transition-colors duration-200">
                        <button type="button"
                                onclick="showDetails('{{ registro.demanda }}', '{{ registro.data }}', '{{ registro.assunto }}', '{{ registro.local }}', '{{ registro.direcionamentos }}', '{{ registro.status }}', '{{ registro.ultimo_editor }}', '{{ registro.data_ultima_edicao }}')" 
                                class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 mr-2 transition-colors duration-200">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="bg-white dark:bg-gray-800 shadow-md rounded-lg p-6 text-center transition-all duration-200">
        <p class="text-gray-600 dark:text-gray-400 text-lg transition-colors duration-200">Nenhum registro encontrado.</p>
        <p class="mt-2 text-gray-600 dark:text-gray-400 transition-colors duration-200">
            Clique em <span class="font-bold">Nova Demanda</span> para adicionar um registro.
        </p>
    </div>
    {% endif %}
</div>

<!-- Modal de Detalhes -->
<div id="detailsModal" class="fixed inset-0 flex items-center justify-center z-50 bg-black bg-opacity-50 hidden transition-opacity duration-200">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full mx-4 transition-all duration-200 transform scale-95 opacity-0" id="modalContent">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white transition-colors duration-200" id="modalTitle"></h2>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Data</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalData"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Assunto</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalAssunto"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Local</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalLocal"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Direcionamentos</p>
                    <p class="text-lg text-gray-900 dark:text-white whitespace-pre-line transition-colors duration-200" id="modalDirecionamentos"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Status</p>
                    <p class="inline-block px-2 py-1 text-sm rounded-full mt-1 transition-colors duration-200" id="modalStatus"></p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400 transition-colors duration-200">Última Edição</p>
                    <p class="text-lg text-gray-900 dark:text-white transition-colors duration-200" id="modalUltimaEdicao"></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Função para filtrar registros na tabela
document.getElementById('searchInput').addEventListener('input', filterRegistros);
document.getElementById('statusFilter').addEventListener('change', filterRegistros);

function filterRegistros() {
    const searchValue = document.getElementById('searchInput').value.toLowerCase();
    const statusValue = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('[data-demanda-row]');
    
    rows.forEach(row => {
        const demanda = row.getAttribute('data-demanda').toLowerCase();
        const assunto = row.getAttribute('data-assunto').toLowerCase();
        const status = row.getAttribute('data-status');
        
        const matchesSearch = demanda.includes(searchValue) || assunto.includes(searchValue);
        const matchesStatus = statusValue === '' || status === statusValue;
        
        if (matchesSearch && matchesStatus) {
            row.classList.remove('hidden');
        } else {
            row.classList.add('hidden');
        }
    });
}

// Funções do modal
function showDetails(demanda, data, assunto, local, direcionamentos, status, ultimo_editor, data_ultima_edicao) {
    document.getElementById('modalTitle').textContent = demanda;
    document.getElementById('modalData').textContent = data;
    document.getElementById('modalAssunto').textContent = assunto;
    document.getElementById('modalLocal').textContent = local;
    document.getElementById('modalDirecionamentos').textContent = direcionamentos || 'Não informado';
    
    const statusEl = document.getElementById('modalStatus');
    statusEl.textContent = status;
    
    // Estilos para o status
    statusEl.className = 'inline-block px-2 py-1 text-sm rounded-full mt-1 transition-colors duration-200';
    
    if (status === 'Em andamento') {
        statusEl.classList.add('bg-blue-100', 'dark:bg-blue-900/50', 'text-blue-800', 'dark:text-blue-300', 'border', 'border-blue-200', 'dark:border-blue-800');
    } else if (status === 'Concluído') {
        statusEl.classList.add('bg-green-100', 'dark:bg-green-900/50', 'text-green-800', 'dark:text-green-300', 'border', 'border-green-200', 'dark:border-green-800');
    } else if (status === 'Pendente') {
        statusEl.classList.add('bg-yellow-100', 'dark:bg-yellow-900/50', 'text-yellow-800', 'dark:text-yellow-300', 'border', 'border-yellow-200', 'dark:border-yellow-800');
    } else if (status === 'Cancelado') {
        statusEl.classList.add('bg-red-100', 'dark:bg-red-900/50', 'text-red-800', 'dark:text-red-300', 'border', 'border-red-200', 'dark:border-red-800');
    }
    
    // Formatar a data de última edição
    const ultimaEdicao = ultimo_editor ? 
        `Por ${ultimo_editor} em ${new Date(data_ultima_edicao).toLocaleString()}` : 
        'Não disponível';
    document.getElementById('modalUltimaEdicao').textContent = ultimaEdicao;
    
    // Mostrar o modal com animação
    const modal = document.getElementById('detailsModal');
    const modalContent = document.getElementById('modalContent');
    
    modal.classList.remove('hidden');
    setTimeout(() => {
        modalContent.classList.remove('scale-95', 'opacity-0');
        modalContent.classList.add('scale-100', 'opacity-100');
    }, 10);
}

function closeModal() {
    const modal = document.getElementById('detailsModal');
    const modalContent = document.getElementById('modalContent');
    
    modalContent.classList.remove('scale-100', 'opacity-100');
    modalContent.classList.add('scale-95', 'opacity-0');
    
    setTimeout(() => {
        modal.classList.add('hidden');
    }, 200);
}

// Fechar o modal quando clicar fora dele
document.getElementById('detailsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});

// Fechar o modal com a tecla ESC
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && !document.getElementById('detailsModal').classList.contains('hidden')) {
        closeModal();
    }
});
</script>
{% endblock %}
